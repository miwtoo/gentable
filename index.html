<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GEN TABLE</title>
    <script src="js/jquery-3.2.1.min.js" type="text/javascript"></script>
    <script src="js/jquery.ajax-cross-origin.min.js" type="text/javascript"></script>
    <script src="js/jscolor.min.js" type="text/javascript"></script>

    </script>
</head>
<body>
    <style>
        table, tr,td {
          border: 1px solid black;
          padding : 10px
        }
        table {
          border-collapse: collapse;
        }
    </style>
    <input type="button" class="Add" value="+">
    <input type="button" class="Del" value="-">
    <table>
        <tr class="time">
            <td>วัน/เวลา</td>
            <td>08:00-09:00</td>
            <td>09:00-10:00</td>

        </tr>
        <tr class="Mo">
            <td>วันจันทร์</td>
            <td class="08"></td>
            <td class="09"></td>

        </tr>
        <tr class="Tu">
            <td>อังคาร</td>
            <td class="08"></td>
            <td class="09"></td>

        </tr>
        <tr class="We">
            <td>พุธ</td>
            <td class="08"></td>
            <td class="09"></td>

        </tr>
        <tr class="Th">
            <td>พฤหัสบดี</td>
            <td class="08"></td>
            <td class="09"></td>

        </tr>
        <tr class="Fr">
            <td>ศุกร์</td>
            <td class="08"></td>
            <td class="09"></td>

        </tr>
    </table>
    
    <div class="header">
        <h2>My subject</h2>
        <input type="text" placeholder="รหัสวิชา" class="classid" value="202211">
        <input type="text" placeholder="กลุ่ม" class="group" value="1">
        <input class="jscolor" value="00FFFF">
        <input type="button" value="Add" onclick="getdata(0)">
        <input type="button" value="Delclsss" onclick="delclass(0)">
    </div>
    <ui id="subject">
        <li class="todo">202211 Group 1 <button class="jscolor {valueElement:null,value:'66ccff'}" style="width:20px; height:15px;"></button></li>
        <li class="todo">523271 Group 1 <button class="jscolor {valueElement:null,value:'66ccff'}" style="width:20px; height:15px;"></button></li>
    </ui>
    <img id="load" src="200.gif">

    <script>
        $('#load').hide();
      var datasrc;
      function Add() {
        time = $("tr.time td:last-child").text();
        var f_time = time.slice(0, 2);
        f_time++;
        var l_time = time.slice(6, 8);
        l_time++;
        $("tr.time").append("<td>" + f_time + ":00" + "-" + l_time + ":00" + "</td>");

        $("tr.Mo").append('<td class="'+f_time+'"></td>');
        $("tr.Tu").append('<td class="'+f_time+'"></td>');
        $("tr.We").append('<td class="'+f_time+'"></td>');
        $("tr.Th").append('<td class="'+f_time+'"></td>');
        $("tr.Fr").append('<td class="'+f_time+'"></td>');
      };

      $(".Del").click(function() {
        if ($("tr:empty")) {
          $("tr td:last-child").remove();
        } else {
          alert("ลบไม่ได้");
        }
      })

      function getdata(x) {
          var classid = $('.classid:eq('+x+')').val();
          var group = $('.group:eq('+x+')').val()
          var color = $('.jscolor:eq('+x+')').val()
          geturl(classid,group,color)
      };

      function geturl(classid, group ,color) {
          var regurl = 'http://reg6.sut.ac.th/registrar/class_info_1.asp?coursestatus=O00&facultyid=all&maxrow=50&acadyear=2560&semester=1&CAMPUSID=&LEVELID=&coursecode='+classid+'&coursename=&cmd=2';

          $.ajax({
            crossOrigin: true,
            url: regurl,
            proxy: "https://miwtoo.000webhostapp.com/proxy.php",
            charset: 'windows-874',
              beforeSend: function(){
            //alert("beforeSend");
            $('#load').show();
         },
            complete: function(){
            //alert("complete");
             $('#load').hide();
          },
            success: function(data) {
            
              datasrc = data;
              //$('#test').html(datasrc)
              var res = datasrc.match(/[A-Z][A-Z](?=<.font><.b><font color=#808080>)<.*?>[0-9][0-9]:[0-9][0-9]-[0-9][0-9]:[0-9][0-9] <U>(.*?)<.u>(.*?)[0-9][0-9]*(?=&nbsp;<.TD>)/gi);
              var res = res[group-1].match(/[A-Z][a-z](?=<.font><.b><font color=#808080>)|[0-9][0-9]:[0-9][0-9]-[0-9][0-9]:[0-9][0-9]|(<U>).*?(?=<.u>)/gi);
              res = res.join();
              console.log(res);
              var day = res.match(/[A-Z][a-z](?=,[0-9])/gi);
              var time = res.match(/[0-9][0-9](?=:[0-9][0-9])/gi).join("").match(/[0-9][0-9][0-9][0-9]/g);
              console.log(day);
              console.log(time);

              for (var j = 0; j < day.length; j++) {
                if(time[j].slice(2,4)-1 > $("tr.Mo td:last-child").attr('class')){
                  while (time[j].slice(2,4)-1 > $("tr.Mo td:last-child").attr('class')) {
                    Add();
                  }
                }
                for (var i = time[j].slice(0,2); i < time[j].slice(2,4); i++) {
                  var t = document.createTextNode(classid+','+group);
                  $("tr."+day[j]+" td."+i).html(t).css("background-color", '#'+color);
                }
              }
            newElement();
            }
          });
        };

        function Delclass(classid,group){
            var day = ["Mo","Tu","We","Th","Fr"];
            console.log(classid);
            console.log(group);
            for (var i = 0; i < 5; i++) {
              for (var j = 8; j <= $("tr.Mo td:last-child").attr('class'); j++) {
                if ($('tr.'+day[i]+' td.'+j+'').html() == (''+classid+','+group+'') || $('tr.'+day[i]+' td.08').html() == (''+classid+','+group+'') || $('tr.'+day[i]+' td.09').html() == (''+classid+','+group+'')) {

                  if(j == 8){
                    $('tr.'+day[i]+' td.08').html('').css("background-color", '#'+'FFFFFF');
                  }
                  else if(j == 9){
                    $('tr.'+day[i]+' td.09').html('').css("background-color", '#'+'FFFFFF');

                  }
                  else{
                  $('tr.'+day[i]+' td.'+j+'').html('').css("background-color", '#'+'FFFFFF');
                  }
                }
              }
            }
        };

        function update(jscolor) {
          //http://jscolor.com/examples/
          $('tr.Mo td.10').css("background-color", '#'+jscolor);
        }
        /*$('#btn').click(function() {
            var group = $('.group').val()-1;
            var classid = $('#classid').val();
            var res = datasrc.match(/[A-Z][A-Z](?=<.font><.b><font color=#808080>)<.*?>[0-9][0-9]:[0-9][0-9]-[0-9][0-9]:[0-9][0-9] <U>(.*?)<.u>(.*?)[0-9][0-9]*(?=&nbsp;<.TD>)/gi);
            var res = res[group].match(/[A-Z][a-z](?=<.font><.b><font color=#808080>)|[0-9][0-9]:[0-9][0-9]-[0-9][0-9]:[0-9][0-9]|(<U>).*?(?=<.u>)/gi);
            res = res.join();
            console.log(res);

            var day = res.match(/[A-Z][a-z](?=,[0-9])/gi);
            var time = res.match(/[0-9][0-9](?=:[0-9][0-9])/gi).join("").match(/[0-9][0-9][0-9][0-9]/g);


            for (var j = 0; j < day.length; j++) {
              for (var i = time[j].slice(0,2); i < time[j].slice(2,4); i++) {
                var t = document.createTextNode(classid+','+group+1);
                $("tr."+day[j]+" td."+i).html(t).css("background-color", "yellow");
              }
            }


            //$('#test').html(res)
          });*/
        
        
        // Create a "close" button and append it to each list item
        var myNodelist = document.getElementsByTagName("LI");
        var i;
        for(i = 0; i < myNodelist.length; i++){
            var span = document.createElement("SPAN");
            var txt = document.createTextNode("\u00D7");
            span.className = 'close'
            span.appendChild(txt);
            myNodelist[i].appendChild(span);
        }
        //Click on a close button to hide the current list item
        var close = document.getElementsByClassName("close");
        var i;
        for(i = 0; i < close.length; i++){
            close[i].onclick = function(){
                var div = this.parentElement;
                div.style.display = "none";
            }
        }
        // Create a new list item when clicking on the "Add" button
        function newElement(){
            var li = document.createElement("li");
            var classid = $('.classid').val();
            var group = $('.group').val();
            var t = document.createTextNode(classid + " Group "+ group);
            
            li.appendChild(t);
            if((classid && group) === ''){
                alert("Write something!");
            }
            else{
                document.getElementById("subject").appendChild(li);
            }
            //$('.classid').val() = '';
            //$('.group').val() = '';
            
            var span = document.createElement("SPAN");
            var txt = document.createTextNode("\u00D7");
            span.className = "close";
            span.appendChild(txt);
            li.appendChild(span);

            for (i = 0; i < close.length; i++) {
                close[i].onclick = function() {
                    var div = this.parentElement;
                    div.style.display = "none";
                    function delclass(x) {
                        var classid = $('.classid:eq('+x+')').val();
                        var group = $('.group:eq('+x+')').val();
                        Delclass(classid,group);
                     }
                }
            }
        }
    </script>
</body>
</html>
